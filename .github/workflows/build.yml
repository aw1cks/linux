---
name: Build

permissions:
  contents: write
  packages: write

on:
  schedule:
    - cron: 30 4 */3 * *
  workflow_dispatch:

jobs:
  get_tags:
    name: Get all tags
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get latest upstream tags
        uses: ./fetch_tags
        id: versions
    outputs:
      versions: ${{ steps.versions.outputs.versions }}

  build:
    name: Build kernel
    runs-on: ubuntu-latest
    needs:
      - get_tags
    strategy:
      matrix:
        version: ${{ fromJSON(needs.get_tags.outputs.versions) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          ref: ${{ matrix.version }}
      - name: Build kernel
        uses: ./build_kernel
        with:
          args: ${{ matrix.version }}
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.pkg.tar.zst*
